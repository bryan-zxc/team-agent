# Production overlay â€” use with:
#   docker compose --env-file .env.prod -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# The --env-file flag loads .env.prod for variable interpolation (overrides .env).
# Before GHCR images exist, add --build to build locally.

services:
  frontend:
    image: ghcr.io/bryan-zxc/team-agent/frontend:${TAG:-latest}
    command: ["npm", "run", "start"]
    ports: !override []
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
    depends_on: !override {}
    restart: unless-stopped

  api:
    image: ghcr.io/bryan-zxc/team-agent/api:${TAG:-latest}
    command: ["uv", "run", "uvicorn", "src.api.main:app", "--host", "0.0.0.0", "--port", "8000"]
    ports: !override []
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=${LOG_FORMAT:-json}
      - AI_SERVICE_URL=${AI_SERVICE_URL:-http://ai-service:8001}
      - TEAM_AGENT_ENV=prod
    volumes: !override
      - project_data:/data/projects
    restart: unless-stopped

  ai-service:
    image: ghcr.io/bryan-zxc/team-agent/ai-service:${TAG:-latest}
    env_file: !override
      - .env.prod
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - MODEL=${MODEL:-claude-opus-4-6}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-3-pro-preview}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-5.2}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=${LOG_FORMAT:-json}
      - TEAM_AGENT_ENV=prod
      - API_SERVICE_URL=${API_SERVICE_URL:-http://api:8000}
    restart: unless-stopped

  postgres:
    ports: !override []
    restart: unless-stopped

  redis:
    ports: !override []
    restart: unless-stopped

  caddy:
    image: caddy:2-alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - frontend
      - api
    restart: unless-stopped

volumes:
  caddy_data:
  caddy_config:
